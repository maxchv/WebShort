<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <!-- Firebase App (the core Firebase SDK) is always required and must be listed first -->
    <script src="https://www.gstatic.com/firebasejs/7.14.5/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/7.14.5/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/7.14.5/firebase-auth.js"></script>

    <script src="https://www.gstatic.com/firebasejs/ui/4.5.1/firebase-ui-auth__ru.js"></script>
    <link type="text/css" rel="stylesheet" href="https://www.gstatic.com/firebasejs/ui/4.5.1/firebase-ui-auth.css" />

    <style>
        table {
            border-collapse: collapse;
            margin: 50px auto;
            min-width: 500px;
        }

        table,
        th,
        td {
            border: 1px solid;
        }

        ol {
            max-height: 200px;
            overflow-y: auto;
        }

        ol {
            list-style-position: outside;
        }
    </style>
</head>

<body>
    <header>
        <select>
            <option>all</option>
            <option>tutorial1</option>
            <option>tutorial2</option>
            <option>tutorial3</option>
        </select>
    </header>
    <table>
        <thead>
            <tr>
                <th>Name</th>
                <th>Code</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>
    <script>

        const process = {
            firebaseConfig: {
                apiKey: 'AIzaSyBvR7BIHXwChpYp4AEKzEr2J5_9y_j3q3U',
                authDomain: 'dom-tutorial.firebaseapp.com',
                projectId: 'dom-tutorial'
            },
            init: function () {
                firebase.initializeApp(this.firebaseConfig);
                this.start(() => true)
            },
            start: function (filter) {
                this.filter = filter;
                firebase.auth().onAuthStateChanged((user) => {
                    if (user) {
                        console.log(user);
                        this.db = firebase.firestore();
                        this.table = document.querySelector("tbody");
                        this.table.innerHTML = '';
                        this.listenUsers(this.db);
                    } else {
                        location = 'login.html';
                    }
                });
            },
            addUser: function (user, userId) {
                console.log('addUser', user, userId);
                const row = document.createElement("tr");
                row.id = userId;
                const td = document.createElement("td");
                td.append(document.createTextNode(user.fullName));
                row.append(td);
                const codeTd = document.createElement("td");
                codeTd.append(document.createElement("ol"));
                row.append(codeTd);
                this.table.prepend(row);
            },
            addAttempt: function (userId, data, tutorial) {
                console.log('addAttempt', userId, data, tutorial);
                const tr = document.querySelector(`#${userId}`);
                const ol = tr.lastElementChild.firstElementChild;
                const li = document.createElement("li");
                li.append(document.createTextNode(
                    `[${tutorial} #${data.task}] ${data.code} (${data.timestamp.toDate().toLocaleString('UK')})`
                ));
                ol.prepend(li);
            },
            listenUsers: function (db) {
                db.collection("users")
                    .orderBy("lastSee")
                    .onSnapshot(querySnapshot => {
                        querySnapshot.docChanges().forEach(userChanges => {
                            const user = userChanges.doc.data();
                            const userId = userChanges.doc.id;
                            this.addUser(user, userId);
                            this.listenAttempt(userId, db.collection("users").doc(userId));
                        });
                    });
            },
            listenAttempt: function (userId, ref) {
                ['tutorial1', 'tutorial2', 'tutorial3']
                    .filter(t => this.filter(t))
                    .forEach(tutorial => {
                        ref.collection(tutorial)
                            .orderBy("timestamp")
                            .onSnapshot(querySnapshot => {
                                querySnapshot.docChanges().forEach(codeChanges => {
                                    const data = codeChanges.doc.data();
                                    this.addAttempt(userId, data, tutorial);
                                    console.log(codeChanges.doc.id, data);
                                });
                            });
                    });
            }
        };

        const selectTutorial = document.querySelector('select');
        selectTutorial.addEventListener('change', function (e) {
            console.log(e.target.value);
            const v = e.target.value;
            process.start(t => v === 'all' ? true : v === t);
        });

        process.init();
    </script>

</body>

</html>